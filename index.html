<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Crane Weather Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
      color: #eee;
      padding: 2rem;
      margin: 0;
    }
    h1, h2, p {
      text-align: center;
    }
    .status {
      font-weight: bold;
      text-align: center;
      color: lime;
      margin-bottom: 1rem;
    }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    .icon-card {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .icon-card img {
      width: 24px;
      height: 24px;
    }
    canvas {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 10px;
      margin-top: 2rem;
      width: 100%;
    }
    .export-btn, .reconnect-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      background: #2d88ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .reconnect-btn {
      background: #e67e22;
    }
    .countdown {
      text-align: center;
      margin-top: -10px;
      font-size: 0.9em;
      color: #ffd700;
    }
    .compass {
      width: 150px;
      height: 150px;
      border: 5px solid #eee;
      border-radius: 50%;
      position: relative;
      margin: 2rem auto;
      background: rgba(255,255,255,0.05);
    }
    .needle {
      width: 2px;
      height: 70px;
      background: red;
      position: absolute;
      top: 5px;
      left: 50%;
      transform-origin: bottom center;
      transform: rotate(0deg);
    }
  </style>
</head>
<body>

  <h1>🌤️ Crane Weather Station</h1>
  <p class="status" id="firebaseStatus">Connecting to Firebase...</p>
  <p class="countdown" id="retryTimer"></p>

  <div class="card-grid">
    <div class="card"><p>🌡️ Temperature</p><h2 id="temp">-- °C</h2></div>
    <div class="card"><p>💧 Humidity</p><h2 id="humidity">-- %</h2></div>
    <div class="card"><p>📈 Pressure</p><h2 id="pressure">-- hPa</h2></div>
    <div class="card"><p>🌪️ Wind Speed</p><h2 id="windSpeed">-- m/s</h2></div>
  </div>

  <div class="card-grid">
    <div class="card icon-card"><img src="https://img.icons8.com/color/48/sunrise.png" /><p id="sunrise">Sunrise: --:--</p></div>
    <div class="card icon-card"><img src="https://img.icons8.com/color/48/sun--v1.png" /><p id="uvIndex">UV Index: --</p></div>
    <div class="card icon-card"><img src="https://img.icons8.com/color/48/fog-day.png" /><p id="airQuality">Air Quality: --</p></div>
  </div>

  <div class="card" style="max-width: 300px; margin: 2rem auto;">
    <p>🧭 Wind Direction</p>
    <div class="compass"><div class="needle" id="needle"></div></div>
  </div>

  <canvas id="tempChart"></canvas>
  <canvas id="humidityChart"></canvas>
  <canvas id="pressureChart"></canvas>

  <button class="export-btn" onclick="exportCSV()">📥 Export CSV</button>
  <button class="reconnect-btn" onclick="reconnect()">🔄 Reconnect</button>

  <script>
    const maxPoints = 20;
    const history = [];
    let fetchInterval;
    let lastTimestamp = null;
    let retryCountdown = 30;
    let countdownInterval;

    const toast = (msg, type = "info") => {
      Toastify({
        text: msg,
        duration: 3000,
        gravity: "top",
        position: "center",
        backgroundColor: type === "error" ? "#ff4444" : "#2ecc71"
      }).showToast();
    };

    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Temperature (°C)', data: [], borderColor: 'orange', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    const humidityChart = new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Humidity (%)', data: [], borderColor: 'cyan', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    const pressureChart = new Chart(document.getElementById('pressureChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Pressure (hPa)', data: [], borderColor: 'lime', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    async function fetchData() {
      try {
        const res = await fetch("https://weather-station-1b75f-default-rtdb.firebaseio.com/sensor.json");
        if (!res.ok) throw new Error("Disconnected");

        const data = await res.json();
        const currentTimestamp = data.timestamp;

        if (lastTimestamp && currentTimestamp === lastTimestamp) {
          disconnect("⚠️ ESP32 Disconnected (No new timestamp)");
          return;
        }

        lastTimestamp = currentTimestamp;
        document.getElementById("firebaseStatus").textContent = "Connected ✅";
        document.getElementById("retryTimer").textContent = "";

        const now = new Date().toLocaleTimeString();
        updateReading("temp", data.temperature_dht, tempChart, now);
        updateReading("humidity", data.humidity, humidityChart, now);
        updateReading("pressure", data.pressure, pressureChart, now);
        updateWind(data.wind_speed, data.wind_direction);

        // Mock data
        document.getElementById("sunrise").textContent = "Sunrise: 06:15 AM";
        document.getElementById("uvIndex").textContent = "UV Index: 7 (High)";
        document.getElementById("airQuality").textContent = "Air Quality: Moderate";

        history.push({
          timestamp: currentTimestamp,
          temperature: data.temperature_dht,
          humidity: data.humidity,
          pressure: data.pressure,
          wind_speed: data.wind_speed,
          wind_direction: data.wind_direction
        });

        toast("✅ Sensor data updated");
      } catch (err) {
        disconnect("❌ Failed to fetch data");
      }
    }

    function disconnect(msg) {
      clearInterval(fetchInterval);
      document.getElementById("firebaseStatus").textContent = msg;
      toast(msg, "error");
      startCountdown();
    }

    function startCountdown() {
      retryCountdown = 30;
      countdownInterval = setInterval(() => {
        retryCountdown--;
        document.getElementById("retryTimer").textContent = `Retrying in ${retryCountdown}s...`;
        if (retryCountdown === 0) {
          clearInterval(countdownInterval);
          reconnect();
        }
      }, 1000);
    }

    function reconnect() {
      toast("🔄 Reconnecting...");
      document.getElementById("firebaseStatus").textContent = "Reconnecting...";
      fetchData();
      fetchInterval = setInterval(fetchData, 5000);
    }

    function updateReading(id, value, chart, label) {
      document.getElementById(id).textContent = `${value}`;
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > maxPoints) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    function updateWind(speed, direction) {
      document.getElementById("windSpeed").textContent = `${speed} m/s`;
      document.getElementById("needle").style.transform = `rotate(${direction}deg)`;
    }

    function exportCSV() {
      let csv = "Timestamp,Temperature,Humidity,Pressure,WindSpeed,WindDirection\n";
      history.forEach(e => {
        csv += `${e.timestamp},${e.temperature},${e.humidity},${e.pressure},${e.wind_speed},${e.wind_direction}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "weather_history.csv";
      link.click();
    }

    // Start fetching
    reconnect();
  </script>
</body>
</html>
