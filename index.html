<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crane Weather Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364);
      color: #eee;
      padding: 2rem;
      margin: 0;
    }
    h1, h2, p {
      text-align: center;
    }
    .card-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }
    .card {
      background: rgba(255, 255, 255, 0.05);
      padding: 1rem;
      border-radius: 12px;
      text-align: center;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
    }
    canvas {
      background: #1e1e1e;
      padding: 1rem;
      border-radius: 10px;
      margin-top: 20px;
      width: 100%;
    }
    .status {
      text-align: center;
      color: lime;
      margin-bottom: 1rem;
      font-weight: bold;
    }
    .export-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      background: #2d88ff;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    .compass {
      width: 150px;
      height: 150px;
      border: 5px solid #eee;
      border-radius: 50%;
      position: relative;
      margin: 20px auto;
      background: rgba(255,255,255,0.05);
    }
    .needle {
      width: 2px;
      height: 70px;
      background: red;
      position: absolute;
      top: 5px;
      left: 50%;
      transform-origin: bottom center;
      transform: rotate(0deg);
    }
  </style>
</head>
<body>
  <h1>üå§Ô∏è Crane Weather Station</h1>
  <p class="status" id="firebaseStatus">Connecting to Firebase...</p>

  <div class="card-grid">
    <div class="card"><p>Temperature</p><h2 id="temp">-- ¬∞C</h2></div>
    <div class="card"><p>Humidity</p><h2 id="humidity">-- %</h2></div>
    <div class="card"><p>Pressure</p><h2 id="pressure">-- hPa</h2></div>
    <div class="card"><p>Wind Speed</p><h2 id="windSpeed">-- m/s</h2></div>
  </div>

  <div class="card" style="max-width: 300px; margin: 2rem auto;">
    <p>Wind Direction</p>
    <div class="compass">
      <div class="needle" id="needle"></div>
    </div>
  </div>

  <canvas id="tempChart"></canvas>
  <canvas id="humidityChart"></canvas>
  <canvas id="pressureChart"></canvas>

  <button class="export-btn" onclick="exportCSV()">üì• Export CSV</button>

  <script>
    const maxPoints = 20;
    const history = [];
    let fetchInterval;
    let lastTimestamp = null;

    const toast = (msg, type = \"info\") => {
      Toastify({
        text: msg,
        duration: 3000,
        gravity: \"top\",
        position: \"center\",
        backgroundColor: type === \"error\" ? \"#ff4444\" : \"#2ecc71\"
      }).showToast();
    };

    const tempChart = new Chart(document.getElementById('tempChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Temp (¬∞C)', data: [], borderColor: 'orange', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    const humidityChart = new Chart(document.getElementById('humidityChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Humidity (%)', data: [], borderColor: 'cyan', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    const pressureChart = new Chart(document.getElementById('pressureChart'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Pressure (hPa)', data: [], borderColor: 'lime', fill: true }] },
      options: { animation: false, scales: { y: { beginAtZero: true } } }
    });

    async function fetchData() {
      try {
        const res = await fetch("https://weather-station-1b75f-default-rtdb.firebaseio.com/sensor.json");
        if (!res.ok) throw new Error("Disconnected");

        const data = await res.json();
        const currentTimestamp = data.timestamp;

        if (lastTimestamp && currentTimestamp === lastTimestamp) {
          clearInterval(fetchInterval);
          document.getElementById("firebaseStatus").textContent = "Sensor Offline ‚ö†Ô∏è (No new data)";
          toast("‚ö†Ô∏è Sensor has stopped sending data", "error");
          return;
        }

        lastTimestamp = currentTimestamp;

        const time = new Date().toLocaleTimeString();
        document.getElementById("firebaseStatus").textContent = "Connected ‚úÖ";

        updateReading("temp", data.temperature_dht, tempChart, time);
        updateReading("humidity", data.humidity, humidityChart, time);
        updateReading("pressure", data.pressure, pressureChart, time);
        updateWind(data.wind_speed, data.wind_direction);

        history.push({
          timestamp: currentTimestamp,
          temperature: data.temperature_dht,
          humidity: data.humidity,
          pressure: data.pressure,
          wind_speed: data.wind_speed,
          wind_direction: data.wind_direction
        });

        toast("‚úÖ Sensor data updated");

      } catch (err) {
        clearInterval(fetchInterval);
        document.getElementById("firebaseStatus").textContent = "Disconnected ‚ùå";
        toast("‚ùå Failed to fetch sensor data. Updates stopped.", "error");
      }
    }

    function updateReading(id, value, chart, label) {
      document.getElementById(id).textContent = `${value}`;
      chart.data.labels.push(label);
      chart.data.datasets[0].data.push(value);
      if (chart.data.labels.length > maxPoints) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }

    function updateWind(speed, direction) {
      document.getElementById("windSpeed").textContent = `${speed} m/s`;
      document.getElementById("needle").style.transform = `rotate(${direction}deg)`;
    }

    function exportCSV() {
      let csv = "Timestamp,Temperature,Humidity,Pressure,WindSpeed,WindDirection\n";
      history.forEach(e => {
        csv += `${e.timestamp},${e.temperature},${e.humidity},${e.pressure},${e.wind_speed},${e.wind_direction}\n`;
      });
      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const link = document.createElement("a");
      link.href = url;
      link.download = "weather_history.csv";
      link.click();
    }

    fetchData();
    fetchInterval = setInterval(fetchData, 5000);
  </script>
</body>
</html>
